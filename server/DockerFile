FROM node:20-alpine

WORKDIR /usr/src/app

# Copy package files first for better caching
COPY server/package*.json ./

# Install dependencies
RUN npm install

# Copy the entire server directory (includes prisma folder)
COPY server/ ./

# Generate Prisma client
RUN npx prisma generate

ENV NODE_ENV=production
EXPOSE 4000

# Copy and make wait script executable
COPY server/wait-for-db.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/wait-for-db.sh

# Run migrations first, then seed, then start server
CMD ["sh", "-c", "wait-for-db.sh db 5432 30 && npx prisma migrate reset --force && npx prisma db seed && node server.js"]